<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link href="/profile-photo.jpeg" rel="icon" type="image/svg+xml"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Joshua Gato | Portfolio Website</title>
</head>
<body>
<div id="root"></div>
<script src="/src/main.jsx" type="module"></script>

<script type="module">
    const apiUrl = import.meta.env.VITE_DJANGO_SERVER_API_URL;

    (async function () {
        // 1. Capture URL immediately
        const initialFullUrl = window.location.href;

        try {
            // 2. Clean URL in address bar
            const urlObj = new URL(initialFullUrl);
            if (urlObj.searchParams.has("ref")) {
                const cleanUrl = urlObj.origin + urlObj.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }

            // 3. Fetch Geo-location
            const geoResponse = await fetch("https://ipapi.co/json/");
            const geo = await geoResponse.json();

            // Improved Device Detection for Safari/Older Browsers
            const getDeviceBrand = () => {
                const ua = navigator.userAgent;
                if (/iPhone|iPad|iPod/.test(ua)) return "Apple iOS Device";
                if (/Macintosh/.test(ua)) return "Apple Mac";
                if (/Android/.test(ua)) return "Android Mobile";
                return "PC/Laptop";
            };

            const visitorData = {
                source_url: initialFullUrl,
                public_ip: geo.ip,
                country: geo.country_name,
                city: geo.city,
                isp: geo.org,
                org: geo.org,
                region: geo.region_code,
                region_name: geo.region,
                timezone: geo.timezone,
                zip_code: geo.postal,
                // Fallback for userAgentData
                browser: (navigator.userAgentData && navigator.userAgentData.brands)
                    ? navigator.userAgentData.brands[0].brand
                    : "Browser (Legacy Check)",
                os: navigator.platform,
                device_info: getDeviceBrand(),
                user_agent: navigator.userAgent,
            };

            // 4. Send to Django API
            if (apiUrl) {
                await fetch(apiUrl, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    mode: "cors",
                    body: JSON.stringify(visitorData),
                });
            }
        } catch (e) {
            console.error("Tracking failed:", e); // Helpful for debugging locally
        }
    })();
</script>
</body>
</html>
